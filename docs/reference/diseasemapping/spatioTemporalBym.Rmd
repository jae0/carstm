```{r header, results='asis', echo=FALSE}
Pmisc::markdownHeader(
  title= "Spatio-temporal area-level models",
  author= "Patrick Brown, University of Toronto and St Mike's",
  date= 'July 2019',
  bibliography= '../../asTwo/astwo.bib',
  theme='Singapore',
  beamer=TRUE,
  classoption=c(
      aspectratio=169,
      xcolor='dvipsnames'),
  biblatexoptions = c(
      maxbibnames=20,
      maxcitenames=3,doi='true', isbn='false', url='true'),
  headerincludes =c(
      '\\usecolortheme[named=MidnightBlue]{structure}',
      '\\newcommand{\\mm}[1]{\\ensuremath{\\boldsymbol{#1}}}',
      '\\DeclareMathOperator{\\MVN}{MVN}'),
  mathCommands=TRUE
)
```





```{r setup, include=FALSE}
library('knitr')

knitr::knit_hooks$set(margins = Pmisc::hook_plot_margins)

knitr::knit_hooks$set(plot=Pmisc::hook_plot_beamer) 

knitr::opts_chunk$set(echo=FALSE, prompt=TRUE, comment=NA,
    dev='pdf', margins=1, fig.cap=' ',
    fig.width=5, fig.height=3, half=NULL,
    tidy=TRUE,tidy.opts=list(indent=2, width.cutoff=55)
)



knitr::opts_hooks$set(half = function(options) {
      options$tidy.opts = list(width.cutoff = 12)#list(options$tidy.opts$width.cutoff/2)
      options
  })

options(width=80)

#$
```





```{r dataSetup}
load("nuts.RData")
euroNuts = readRDS('euroNuts.rds')
euroNutsSub = euroNuts[!euroNuts$CNTR_CODE %in% c("CY",'TR','IE'), c('NUTS_ID','NUTS_NAME','CNTR_CODE')]

xSub = xFinal[xFinal$geo %in% euroNutsSub$NUTS_ID, ]
xSub$logPop = log(xSub$pop)
theRates = glm(deaths ~ offset(logPop) + 0+age:sex, family='poisson', data=xSub)
xSub$expected =  predict(theRates, xSub[,c('logPop','age','sex')], type='response')

euroMelt = reshape2::melt(xSub, 
  id.vars = c('geo','gdp','pctEmp','manure','year', 'sex'),
  measure.vars = c('expected','deaths')
  )
x = reshape2::dcast(
  euroMelt,
  geo + year + gdp + pctEmp + manure ~ variable + sex,
  fun.aggregate = sum
  )
x$smr = x$deaths_F / x$expected_F 
x$logExpected_F = log(x$expected_F)
```


```{r euroMap, cache=TRUE}
euroBg = mapmisc::openmap(euroNutsSub, path='stamen-watercolor')
```

```{r euroMapSetup}

smrCol = mapmisc::colourScale(
  x$smr, breaks=c(0, 0.4, 0.6, 0.8, 1, 1.5, 2, 7.5), 
  style = 'fixed',
  col='Spectral', rev=TRUE)
obsCol = mapmisc::colourScale(
  x$deaths_F, breaks=10, style='equal', dec=-1, digits=1,
  transform='sqrt',
  col='Spectral', rev=TRUE)
obsCol$breaks[length(obsCol$breaks)] = ceiling(max(c(
  obsCol$breaks[length(obsCol$breaks)],
  max(x$expected_F, na.rm=TRUE)))/10)*10

expCol = mapmisc::colourScale(
  x$expected_F, breaks=obsCol$breaks, style='fixed',
  col=obsCol$col)

euroSetup = function() {
  mapmisc::map.new(euroNutsSub, buffer = c(0.01,0.01,-0.1,-1)*1000*1000)
  raster::plotRGB(euroBg, add=TRUE)
}
```

```{r syears}
Syears= sort(unique(x$year))
```

```{r firstStFig, fig.ncol=length(Syears), fig.cap='Motivating example', fig.subcap = paste(rep(c("obs","smr"), length(Syears)), rep(Syears, each=2)), fig.height=4, fig.width=3.8, fig.start='#'}
for(D in Syears) {
  euroSetup()
  thisYear = which(x$year == D)
  geoHere = match(x[thisYear, 'geo'], euroNutsSub$NUTS_ID)
  sp::plot(euroNutsSub, col=obsCol$plot[thisYear][geoHere], border=NA, add=TRUE)

  euroSetup()
  thisYear = which(x$year == D)
  geoHere = match(x[thisYear, 'geo'], euroNutsSub$NUTS_ID)
  sp::plot(euroNutsSub, col=smrCol$plot[thisYear][geoHere], border=NA, add=TRUE)
}
```

# The problem

## The data

- $Y_{it}$ is the death count in region $i$ at time $t$
- $E_{it}$ is the associated expected count

## Possible research questions

- Is there a spatial effect (some regions consistently have high mortality?)
- Is there a time trend (generally falling or rising?)
- How does poverty affect mortality?
- Are some regions improving (or worstening) faster than others?
- Are there some places with a few bad years or good years?

# A Book

\fullcite{blangiardo2015spatial}


# Spatio-temporal models

\bcol

Ignore time

$$
\begin{aligned}
Y_i = & \sum_t Y_{it}\\
Y_{i} \sim &\text{Poisson}(E_{i}\lambda_{i})\\
\log(\lambda_{i}) = & \mu + X_{i}\beta + U_i\\
U_i  \sim & \text{BYM}(\phi, \sigma^2)
\end{aligned}
$$

Space plus time

$$
\begin{aligned}
Y_{it} \sim &\text{Poisson}(E_{it}\lambda_{it})\\
\log(\lambda_{it}) = & \mu + X_{it}\beta + U_i + V_t + W_{it}\\
U_1 \ldots U_N  \sim & \text{BYM}(\phi, \sigma_1^2)\\
V_1 \ldots V_T \sim & \text{RW2}(\sigma_2^2)\\
W_{it} \sim & \text{N}(0, \sigma_3^2)
\end{aligned}
$$

\newcol

Spatio-temporal interaction

$$
\begin{aligned}
Y_{it} \sim &\text{Poisson}(E_{it}\lambda_{it})\\
\log(\lambda_{it}) = & \mu + X_{it}\beta + U_i + V_t + W_{it}\\
U_1 \ldots U_N  \sim & \text{BYM}(\phi_1, \sigma_1^2)\\
V_1 \ldots V_T \sim & \text{RW2}(\sigma_2^2) \\
W_{11} \ldots W_{NT} \sim & ???
\end{aligned}
$$

\ecol

# Ignore time?

- every spatial model does this
- ... every data point has a time associated with it
- usually ok if the time period is short

$$
\begin{aligned}
Y_i = & \sum_t Y_{it}\\
Y_{i} \sim &\text{Poisson}(E_{i}\lambda_{i})\\
\log(\lambda_{i}) = & \mu + X_{i}\beta + U_i\\
U_i  \sim & \text{BYM}(\phi, \sigma^2)
\end{aligned}
$$


# Space plus time

\bcol

- Covariates change in time
- $V_t$ is a time trend (i.e. a random walk)
- $W_{it}$ is an _overdispersion_ term

    - Annual counts are more variable than a Poisson
    - regions have some good years and some bad years

\newcol

$$
\begin{aligned}
Y_{it} \sim &\text{Poisson}(E_{it}\lambda_{it})\\
\log(\lambda_{it}) = & \mu + X_{it}\beta + U_i + V_t + W_{it}\\
U_1 \ldots U_N  \sim & \text{BYM}(\phi, \sigma_1^2)\\
V_1 \ldots V_T \sim & \text{RW2}(\sigma_2^2)\\
W_{it} \sim & \text{iid N}(0, \sigma_3^2
\end{aligned}
$$


\ecol


# 



\bcolb{Random Walks}

- RW(0), independent

$$
V_t \sim \text{iid N}(0, \tau^2)
$$

- RW(1), Brownian motion

$$
\begin{aligned}
V_{t+1} | V_k, k < t \sim & \text{N}(V_t, \tau^2)\\
V_{t+1} - V_t \sim & \text{N}(0, \tau^2)
\end{aligned}
$$


- RW(2), Random slope

$$
\begin{aligned}
V_{t+1} | V_k, k < t \sim & \text{N}(-2 V_t + V_{t-1}, \tau^2)\\
(V_{t+1} - V_t) - (V_{t} - V_{t-1}) \sim & \text{N}(0, \tau^2)
\end{aligned}
$$


\newcolb[0.4]{}

```{r rwgraphs, fig.height=3, fig.width=6}
set.seed(0)
tSeq = seq(0,3, len=21)
z = cbind(0.1*rnorm(length(tSeq)), rnorm(length(tSeq)))

matplot(tSeq, z, lty=1, lwd=2, xlab='time', ylab='rw0', type='l')

z1 = apply(rbind(c(1,-1), z), 2, cumsum)[-1,]
matplot(tSeq, z1, lty=1, lwd=2, xlab='time', ylab='rw1', type='l')

z2 = apply(rbind(c(-6,2), z1), 2, cumsum)[-1,]
matplot(tSeq[1:nrow(z2)], z2, lty=1, lwd=2, xlab='time', ylab='rw2', type='l' )

```


\ecolb






# Some Data

 

```{r stData, echo=TRUE}
x[1:3, c('year','geo','deaths_F', 'expected_F','logExpected_F','gdp')]
x$gdpTrans = log(x$gdp / 
  median(x$gdp, na.rm=TRUE))/log(2)
euroNutsSub@data[1:2,]
```




# When to go spatio-temporal?

- It's part of the research question

    - effecct of a time-varying covariate (temperature?)
    - spatio-temporal predictions
    - identifying 'outbreaks'
- Time is an unignorable nuisance

    - data are unbalanced, temporal covarage better in some areas
    - time-varying covariate is a confounder

# The model

\bcol[0.4]

$$
\begin{aligned}
Y_{it} \sim &\text{Poisson}(E_{it}\lambda_{it})\\
\log(\lambda_{it}) = & \mu_t + X_{it}\beta + U_i + W_{it}\\
U_1 \ldots U_N  \sim & \text{BYM}(\phi_1, \sigma_1^2)\\
W_{it} \sim & \text{iid N}(0, \sigma_2^2)
\end{aligned}
$$

- year is a fixed effect, $\mu_t$ 

    - there are only 5 years of data

\newcol[0.6]

Recode variables

```{r xDf, tidy=FALSE, echo=TRUE}
x$yearFac = factor(x$year)
x$yearInt = as.integer(x$yearFac)
```

Neighbourhood matrix 

```{r xNb, cache=TRUE, tidy=FALSE, echo=TRUE}
xNb = spdep::poly2nb(euroNutsSub, 
  row.names=euroNutsSub$NUTS_ID)
```

\ecol

# Fitting

```{r fitPlainStOverDisp, echo=TRUE, eval=FALSE, tidy=FALSE, warning=FALSE}
fitStOD = diseasemapping::bym(
  deaths_F ~ offset(logExpected_F) + yearFac + gdpTrans +
    f(geo, model='iid', replicate=yearInt, 
      prior='pc.prec', param=c(log(1.5), 0.5)),
  data = x, region.id = 'geo', adjMat = xNb, family='poisson',
  prior = list(sd = c(log(1.5), 0.5), propSpatial =c(0.5, 0.5)))
```
```{r fitPlainStOverDisp, cache=TRUE, eval=TRUE, include=FALSE}
```
- `f(geo, replicate=` is $W_{it}$
- $\sigma^2$ has an exponential prior with median $\log(1.5)$

    - corresponding to a 50% increase when $W_{it} = \sigma$


# Parameter estimates

```{r odStRes, echo=TRUE}
knitr::kable(fitStOD$parameters$summary, digits=2)
```

- decreasing over time
- wealth is protective


# Parameter estimates again


```{r odStRes2, echo=TRUE}
qCols = paste0(c(0.5, 0.025, 0.975), 'quant')
myTable = rbind(
  exp(fitStOD$parameters$summary[-(7:8),qCols]),
  fitStOD$parameters$summary[7:8,qCols],
  sdW = 1/sqrt(fitStOD$inla$summary.hyperpar[
    'Precision for geo', qCols[c(1,3,2)]]))
knitr::kable(myTable, digits=2)
```

# Plotting the spatial random effect

\bcol[0.6]

```{r spatialMeanData, echo=TRUE, half=TRUE}
dim(fitStOD$data)
length(euroNutsSub)
names(fitStOD$data)[1:9]
```

\newcol[0.4]

```{r spatialMeanPlot, eval=TRUE, echo=FALSE, fig.height=4, fig.width=5}
randomCol = mapmisc::colourScale(exp(fitStOD$data$random.0.5quant),
  breaks = 9, digits=1.5, col='Spectral', rev=TRUE, 
  style='equal', transform='log')
mapmisc::map.new(euroNutsSub, buffer = c(0,0,0,-1000*1000))
sp::plot(euroNutsSub, col=randomCol$plot, border=NA, add=TRUE)
mapmisc::legendBreaks('topright', randomCol, cex=0.7, bty='n')
```

\ecol

```{r spatialMeanPlot, eval=FALSE, echo=TRUE, tidy=FALSE}
```

# Fitted values

- There's a different map of $\lambda$ for every year
- `bym` produces a single set of fitted values in `fitStOD$data$fitted.mean`
- for the 'baseline' year (where all time-varying covariates are zero)


```{r fittedMean, echo=TRUE}
unlist(fitStOD$inla$.args$lincomb[[1]])
levels(fitStOD$inla$.args$data$yearFac)
```

- gdp is constant over time so it's added to preditcions
- `r levels(fitStOD$inla$.args$data$yearFac)[1]` is the baseline year

# Plotting fitted values

\bcol

```{r fittedMeanPlot, eval=FALSE, echo=TRUE, half=TRUE, tidy=FALSE}
fittedCol = mapmisc::colourScale(
  exp(fitStOD$data$fitted.0.5quant),
  breaks = 9, digits=1.5, 
  col='Spectral', rev=TRUE, 
  style='equal', transform='log')
mapmisc::map.new(euroNutsSub,
  buffer = c(0,0,0,-1000*1000))
sp::plot(euroNutsSub, 
  col=fittedCol$plot, 
  border=NA, add=TRUE)
mapmisc::legendBreaks('topleft', 
  fittedCol, cex=0.8, bty='n')
```

\newcol

```{r fittedMeanPlot, eval=TRUE, echo=FALSE, fig.height=5, fig.width=5}
```

```{r fitFullStOverDisp, cache=TRUE, eval=FALSE, tidy=FALSE}
fitStFull = INLA::inla(
  deaths ~ offset(logExpected) + yearFac + gdpTrans + 
    f(regionSpace, model='bym2', graph=graphFile, 
      hyper = list(
        theta1 = list(prior='pc.prec', param=c(log(1.5), 0.5)),
        theta2 = list(prior = 'pc', param = c(0.5, 0.5))) ) +
    f(regionST, model='bym2', graph=graphFile, 
      hyper = list(
        theta1 = list(prior='pc.prec', param=c(log(1.5), 0.5)),
        theta2 = list(prior = 'pc', param = c(0.1, 0.5))),
      group=yearInt, control.group = list(model='ar1', hyper = 
        list(theta=list(prior='pccor0', param=c(0.1, 0.5)))) ),
  data = xDfSub, family='poisson',
#  control.inla = list(strategy='gaussian', int.strategy='eb'),
  control.compute = list(config=TRUE), 
  control.mode = list(theta = c(3.52, 0.38, 4.9, 0.17, 3.5), restart=TRUE)
  verbose=TRUE)
\ecol

# Independent random effects (in 2014)

\bcol[0.6]

formula has `f(geo, model='iid', replicate=yearInt,`

```{r overdispData, echo=TRUE, half=TRUE}
length(euroNutsSub)
nlevels(fitStOD$inla$.args$data$yearFac)
dim(fitStOD$inla$summary.random$geo)
```


\newcol[0.4]

```{r overdispPlot, eval=TRUE, echo=FALSE, fig.height=4, fig.width=5}
random2014col=mapmisc::colourScale(exp(fitStOD$inla$summary.random$geo[
    seq(from=length(euroNutsSub)+1,len=length(euroNutsSub)),'0.5quant']),
  breaks = 9, dec=2, style='equal', col='Spectral', rev=TRUE)
mapmisc::map.new(euroNutsSub, buffer = c(0,0,0,-1000*1000))
sp::plot(euroNutsSub, col=random2014col$plot, border=0,add=TRUE)
mapmisc::legendBreaks('topleft', random2014col, bty='n', cex=0.8)
```

\ecol

```{r overdispPlot, eval=FALSE, echo=TRUE, tidy=FALSE}
```

# Spatial v spatio-temporal variance


\bcol[0.45]

- The spatial effect $U_i$ is more important than the spatio-temporal component $W_{it}$
- Estimated standard deviation much larger
- posterior means (on natural scale) further from 1.
- Other than Poisson variation around the mean, there's not much variation in a region over time.

\newcol[0.275]

```{r overdispVariancePLot, fig.cap='', fig.subcap = c('$\\pi[sd(U_i) | Y]$','$\\pi[sd(W_{it}) | Y]$'), fig.height=4, fig.width=5}

plot(fitStOD$parameters$sd$posterior, type='l', xlab='sd', ylab='dens', lwd=2, xlim = c(0, 0.25), ylim = c(0,60))
lines(fitStOD$parameters$sd$prior, col='grey', lwd=2)
legend('topleft', lty=1, lwd=3, col=c('black','grey'), legend=c('post','prior'), bty='n')


toPlot = Pmisc::priorPostSd(fitStOD$inla, group='random', param=1)$posterior
matplot(toPlot[,1], toPlot[,-1], lty=1, col=c('black','grey'),
  type='l', xlab='sd', ylab='dens', lwd=2, xlim = c(0, 0.25), ylim = c(0,60))

```

\newcol[0.275]

```{r spatialMeanPlot, eval=TRUE, echo=FALSE, fig.height=4, fig.width=5}
```

$E[\exp(U_i) | Y]$ 

```{r overdispPlot, eval=TRUE, echo=FALSE, fig.height=4, fig.width=5}
```

$E[\exp(W_{i,2014})| Y]$ 

\ecol

# That model's not really spatio-temporal

- independent errors aren't interesting
- ... because they're not difficult
- the real world is correlated
- ... or the possibility of correlation shouldn't be ruled out
- We need a model for $W_{it}$ with spatio-temporal correlation

# A separable spatio-temporal model

- Build $W_{it}$ from a temporally-independent process $Z_{it}$ 
$$
[Z_{1t} \dots Z_{Nt}]^T \sim \text{BYM}\left[\phi_2, (1-\psi^2)\sigma_2^2\right]
$$
- define $\mathbf{W}_t = [W_{1t} \dots W_{Nt}]^T$ and $\mathbf{Z}_t$ similarly
- AR(1) in time
$$
\mathbf{W}_{t+1} | \{\mathbf{W}_v; v \leq t \}= \psi \mathbf{W}_t + \mathbf{Z}_t 
$$
- Marginal distributions, as $t \rightarrow \infty$
$$
\mathbf{W}_{t} \sim \text{BYM}(\phi_2, \sigma_2^2)
$$
- Initial distribution
$$
\mathbf{W}_{1} \sim \text{BYM}(\phi_2, \sigma_2^2)
$$
makes the process stationary in time


# About the AR(1)$\otimes$BYM model

- The simplest possible area-level spatio-temporal interaction model
- Three parameters

    - $\psi$: temporal correlation parameter, temporally independent if $\psi=0$
    - $\sigma_2$: variance parameter, how important is the effect?
    - $\phi_2$: spatial dependence parameter, are the temporal effects spatially structured?
- \ldots you'd need a very rich dataset to justify the use of any other model
- The precision matrix of $[W_{11} \ldots W_{NT}]^T$ is convenient

    - Sparse
    - Kronecker 
    - Cholesky is a Kronecker of Choleskies
- Easy (?) to fit in `inla`


# Full spatio-temporal interaction model

$$
\begin{aligned}
Y_{it} \sim &\text{Poisson}(E_{it}\lambda_{it})\\
\log(\lambda_{it}) = & \mu + X_{it}\beta + U_i + V_t + W_{it}\\
U_1 \ldots U_N  \sim & \text{BYM}(\phi_1, \sigma_1^2)\\
W_{11} \ldots W_{NT} \sim & \text{AR(1)} \otimes\text{BYM} (\psi, \phi_2, \sigma_2^2)\\
V_1 \ldots V_T \sim & \text{RW2}(\sigma_3^2) \\
\end{aligned}
$$

- the other models we've used are special cases of this one
- this model has the basics:

    - A time trend
    - Spatial variation
    - spatio-temporal effects, possibly correlated in space and/or in time
- ... but nothing more

# Full model

`diseasemapping` package [r-forge.r-project.org/R/?group_id=312](https://r-forge.r-project.org/R/?group_id=312)


```{r diseasemappingpackage, eval=FALSE, echo=TRUE, tidy=FALSE}
install.packages("diseasemapping", 
  repos="http://R-Forge.R-project.org")
```



```{r fitFullSt, eval=FALSE, tidy=TRUE, echo=TRUE}
fitStFull = diseasemapping:::stbym(
deaths_F ~ offset(logExpected_F) + yearFac + gdpTrans,
data = x, adjMat = euroNutsSub,
region.id = c(data='geo',spatial='NUTS_ID'),
time.id = 'year',
prior = list(
  spaceTime = list(
    ar = list(prior='pccor0', param=c(0.25, 0.5)),
    sd = c(u=log(1.1), alpha=0.5),
    propSpatial = c(u=0.5, alpha=0.5)),
  sd = c(log(1.5), 0.5), 
  propSpatial =c(0.5, 0.5)),
  family = 'poisson', control.inla = list(strategy='gaussian',int.strategy='eb'),
  control.mode = list(theta = c(6, 1.5, 0, 3.5, 0), restart=TRUE),
  verbose=TRUE)
```

`control.inla = ` option is fast but less accurate

```{r saveFitStFull, eval=FALSE, include=FALSE}
saveRDS(fitStFull, file='fitStFull.rds')
```
```{r loadFitStFull, eval=TRUE, include=FALSE}
fitStFull = readRDS('fitStFull.rds')
```

# In detail

\bcol[0.55]

```{r fitFullSt2, eval=FALSE, tidy=FALSE, echo=TRUE}
diseasemapping:::stbym(
deaths_F ~ offset(logExpected_F) + 
  yearFac + gdpTrans,
family = 'poisson', data = x,
adjMat = euroNutsSub, time.id = 'year',
region.id = c(data='geo',spatial='NUTS_ID'),
prior = list(
  spaceTime = list(
    ar = list(prior='pccor0',
      param=c(0.25, 0.5)),
    sd = c(u=log(1.1), alpha=0.5),
    propSpatial = c(u=0.5, alpha=0.5)),
  sd = c(log(1.5), 0.5), 
  propSpatial =c(0.5, 0.5)))
```

\newcol[0.45]

- `x` contains covariates and observations
- `euroNutsSub` contains polygons
- the time variable in `x` is `year`
- region variable in `x` is `geo`
- region variable in `euroNutsSub` is `NUTS_ID`
- the `spaceTime` element of `prior` relates to $W_{it}$

    - $|\psi|$ has a prior median of $1/4$
    - $\sigma_2$ has prior median of $\log(1.1)$
    - $\phi_2$ has prior median 0.5 
- `sd` and `propSpatial` priors for $U$ are as before

\ecol

# Parameter estimates


```{r fullResTable, echo=TRUE}
toPrint = rbind(
  exp(fitStFull$inla$summary.fixed[,qCols]),
  fitStFull$parameters$sdSpaceTime$summarySpaceTime[, qCols]
  )
rownames(toPrint) = gsub(' for regionST', ' S-T', rownames(toPrint))
rownames(toPrint) = gsub(' for region.indexS', ' Space', rownames(toPrint))
colnames(toPrint) = gsub("quant", "q", colnames(toPrint))
knitr::kable(toPrint, digits=3)
```

# Parameter estimates

\bcol

```{r fullResTable, echo=FALSE}
```

\newcol

- Mortality decreasing over time, 2017 is 7% lower than 2013
- wealth protects from mortality, doubling gdp lowers mortality by 9%
- Spatial effect more important than spatio-temporal interaction
- spatio-temporal interaction independent in time

\ecol

# Spatial effect $\E(U | Y)$

\bcol

```{r plotStFullRes, echo=TRUE, eval=FALSE, half=TRUE, tidy=FALSE}
ranCol = mapmisc::colourScale(
  exp(fitStFull$data$random.0.5quant),
  breaks = c(0, seq(0.7, 1.2, by=0.1), 
    1.5, 2, 2.5), 
  style='fixed', 
  col='Spectral', rev=TRUE)
mapmisc::map.new(euroNutsSub,
  buffer = c(0,0,0,-1000*1000))
sp::plot(euroNutsSub, 
  col=ranCol$plot, 
  border=NA, add=TRUE)
mapmisc::legendBreaks("topleft", 
  ranCol, cex=0.8, bty='n')
```

\newcol

```{r plotStFullRes, echo=FALSE, fig.height=5, fig.width=5}
```
\ecol

# Spatio-temporal effects $W_{it}$

```{r stFullResStData, echo=TRUE}

names(fitStFull$inla$summary.random)
dim(fitStFull$inla$summary.random$regionST)
dimnames(fitStFull$inla$summary.random$regionST)[-1]


```

```{r plotStFullResSt, fig.start='#', fig.ncol=5, fig.cap='E$(W | Y)$', fig.subcap = dimnames(fitStFull$inla$summary.random$regionST)$time, fig.height=5, fig.width=3}
stRanCol = mapmisc::colourScale(
  exp(fitStFull$inla$summary.random$regionST[,,'0.5quant']),
  breaks = 9, style='equal', dec=2,
  col='Spectral', rev=TRUE
  )

for(D in dimnames(fitStFull$inla$summary.random$regionST)$time) {
  col2 =  mapmisc::colourScale(
  exp(fitStFull$inla$summary.random$regionST[,D,'0.5quant']),
  breaks = stRanCol$breaks, style='fixed',
  col=stRanCol$col)
mapmisc::map.new(euroNutsSub,
  buffer = c(0,0,0,-200*1000))
  sp::plot(euroNutsSub, col=col2$plot, lty=0, add=TRUE)
}
mapmisc::legendBreaks("topleft", stRanCol, cex=0.7, bty='n', inset=0)
```

Not perfectly aligned with national boundaries

# Conclusions

- "All models are wrong, some are useful" (George Box)
- ... is the AR(1)$\otimes$BYM wrong is a consequential way?
- As of 15 July 2019 fitting spatio-temporal BYM models is easy
- if there are 1000 regions and 5 years of data
- \ldots with 100 time points and 10000 regions things get harder
- and if boundaries change, the fun starts

